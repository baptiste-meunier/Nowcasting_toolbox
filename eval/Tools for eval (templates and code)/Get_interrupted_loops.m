
% This file recovers accuracy metrics and parameters for the models of the loops that got interrupted.
% It is made to recover metrics when the out-of-sample period is 01/2013 to 01/2023 (if the period is different, please change values in lines 137 to 176)
% Prior to using this code, the user should put all the Excel files of models in a specific folder
%   - The Excel files for individual models are the ones called xxx_DFM_evaluation_yyy_n with
%       o xxx = country ID
%       o yyy = name of the loop
%       o n = iteration number in the loop
%   - The name of this folder should be written on line 19

clear;

% -------------------------------------------------------------------------
%% 0. ENTER USER SETTINGS
% -------------------------------------------------------------------------

% Parameters
Loop.excel_loopfile = 'GlobalTrade_DFM_interrupted_b4.xlsx'; % name of output Excel
folder_file = './Background - model selection/DFM_interrupted_loops_b4'; % folder with individual Excel
modeltype = 'DFM'; % choices = 'DFM' or 'BEQ' or 'BVAR'


% -------------------------------------------------------------------------
%% 1. PREPARE READING OF FILES
% -------------------------------------------------------------------------

% List content of the folder
listing = dir(folder_file);
listing = listing(3:end); % deleting first two observations (empty file)
Loop.n_iter = size(listing,1);
addpath(folder_file); % adding the fodler with result files

% Get the names (horizons) of the eval structure
C = {'Bac','Now','For'};

% Containers for model parameters and results
Loop.batch_id = cell(Loop.n_iter,1);
for hh = 1:numel(C)
    hor = C{hh};
    Loop.(hor).results = nan(Loop.n_iter,40);
end

switch modeltype
    case 'DFM'
        Loop.parameters = nan(Loop.n_iter,7);
        Loop.results_names = {'batch','n iteration','do_Covid','start year (est.)','nb variables','nb factors','nb lags','blocks', ...
                              'RMSE all','RMSE pre-Covid (<2020)','RMSE Covid (2020)','RMSE post-Covid (>2020)','RMSE no Covid', ...
                              'FDA all','FDA pre-Covid (<2020)','FDA Covid (2020)','FDA post-Covid (>2020)','FDA no Covid', ...
                              '1m - RMSE all','1m - RMSE pre-Covid (<2020)','1m - RMSE Covid (2020)','1m - RMSE post-Covid (>2020)','1m - RMSE no Covid', ...
                              '1m - FDA all','1m - FDA pre-Covid (<2020)','1m - FDA Covid (2020)','1m - FDA post-Covid (>2020)','1m - FDA no Covid', ...
                              '2m - RMSE all','2m - RMSE pre-Covid (<2020)','2m - RMSE Covid (2020)','2m - RMSE post-Covid (>2020)','2m - RMSE no Covid', ...
                              '2m - FDA all','2m - FDA pre-Covid (<2020)','2m - FDA Covid (2020)','2m - FDA post-Covid (>2020)','2m - FDA no Covid', ...
                              '3m - RMSE all','3m - RMSE pre-Covid (<2020)','3m - RMSE Covid (2020)','3m - RMSE post-Covid (>2020)','3m - RMSE no Covid', ...
                              '3m - FDA all','3m - FDA pre-Covid (<2020)','3m - FDA Covid (2020)','3m - FDA post-Covid (>2020)','3m - FDA no Covid', ...
                              ' variables','groups'};
    case 'BEQ'
        Loop.parameters = nan(Loop.n_iter,7);
        Loop.results_names = {'batch','n iteration','do_Covid','start year (est.)','nb variables','nb lagM', 'nb lagQ', 'nb lagY', ...
                              'RMSE all','RMSE pre-Covid (<2020)','RMSE Covid (2020)','RMSE post-Covid (>2020)','RMSE no Covid', ...
                              'FDA all','FDA pre-Covid (<2020)','FDA Covid (2020)','FDA post-Covid (>2020)','FDA no Covid', ...
                              '1m - RMSE all','1m - RMSE pre-Covid (<2020)','1m - RMSE Covid (2020)','1m - RMSE post-Covid (>2020)','1m - RMSE no Covid', ...
                              '1m - FDA all','1m - FDA pre-Covid (<2020)','1m - FDA Covid (2020)','1m - FDA post-Covid (>2020)','1m - FDA no Covid', ...
                              '2m - RMSE all','2m - RMSE pre-Covid (<2020)','2m - RMSE Covid (2020)','2m - RMSE post-Covid (>2020)','2m - RMSE no Covid', ...
                              '2m - FDA all','2m - FDA pre-Covid (<2020)','2m - FDA Covid (2020)','2m - FDA post-Covid (>2020)','2m - FDA no Covid', ...
                              '3m - RMSE all','3m - RMSE pre-Covid (<2020)','3m - RMSE Covid (2020)','3m - RMSE post-Covid (>2020)','3m - RMSE no Covid', ...
                              '3m - FDA all','3m - FDA pre-Covid (<2020)','3m - FDA Covid (2020)','3m - FDA post-Covid (>2020)','3m - FDA no Covid', ...
                              ' variables','groups'};
    case 'BVAR'
        Loop.parameters = nan(Loop.n_iter,5);
        Loop.results_names = {'batch','n iteration','do_Covid','start year (est.)','nb variables','nb lags', ...
                      'RMSE all','RMSE pre-Covid (<2020)','RMSE Covid (2020)','RMSE post-Covid (>2020)','RMSE no Covid', ...
                      'FDA all','FDA pre-Covid (<2020)','FDA Covid (2020)','FDA post-Covid (>2020)','FDA no Covid', ...
                      '1m - RMSE all','1m - RMSE pre-Covid (<2020)','1m - RMSE Covid (2020)','1m - RMSE post-Covid (>2020)','1m - RMSE no Covid', ...
                      '1m - FDA all','1m - FDA pre-Covid (<2020)','1m - FDA Covid (2020)','1m - FDA post-Covid (>2020)','1m - FDA no Covid', ...
                      '2m - RMSE all','2m - RMSE pre-Covid (<2020)','2m - RMSE Covid (2020)','2m - RMSE post-Covid (>2020)','2m - RMSE no Covid', ...
                      '2m - FDA all','2m - FDA pre-Covid (<2020)','2m - FDA Covid (2020)','2m - FDA post-Covid (>2020)','2m - FDA no Covid', ...
                      '3m - RMSE all','3m - RMSE pre-Covid (<2020)','3m - RMSE Covid (2020)','3m - RMSE post-Covid (>2020)','3m - RMSE no Covid', ...
                      '3m - FDA all','3m - FDA pre-Covid (<2020)','3m - FDA Covid (2020)','3m - FDA post-Covid (>2020)','3m - FDA no Covid', ...
                      ' variables','groups'};

end
    
Loop.var_sel = cell(Loop.n_iter,2);


% -------------------------------------------------------------------------
%% 1. READ THE EXCEL FILES
% -------------------------------------------------------------------------

% Loop over the files
for n_iter_mod = 1:Loop.n_iter

    disp(['Getting the file ', num2str(n_iter_mod), ' out of ', num2str(Loop.n_iter)])

    % Get file name
    name_file = listing(n_iter_mod).name;

    % Get the batch
    temp_batch = extractAfter(name_file,'evaluation_');
    temp_batch = extractBefore(temp_batch,'.xlsx');
    idx_last_under = max(strfind(temp_batch,'_'));
    temp_batch = extractBefore(temp_batch,idx_last_under);
    Loop.batch_id(n_iter_mod) = {temp_batch};
    
    % Get parameters and selected variables
    if strcmp(modeltype,'DFM') || strcmp(modeltype,'BEQ')
        Loop.parameters(n_iter_mod,:) = readmatrix(name_file, ...
                                                   'Sheet', ...
                                                   'Parameters', ...
                                                   'Range', ...
                                                   'A2:G2'); % parameters
        Loop.var_sel(n_iter_mod,:) = readcell(name_file, ...
                                            'Sheet', ...
                                            'Parameters', ...
                                            'Range', ...
                                            'H2:I2'); % selected variables (col. 1) and groups (col. 2)
    elseif strcmp(modeltype,'BVAR')
        Loop.parameters(n_iter_mod,:) = readmatrix(name_file, ...
                                           'Sheet', ...
                                           'Parameters', ...
                                           'Range', ...
                                           'A2:E2'); % parameters
        Loop.var_sel(n_iter_mod,:) = readcell(name_file, ...
                                            'Sheet', ...
                                            'Parameters', ...
                                            'Range', ...
                                            'F2:G2'); % selected variables (col. 1) and groups (col. 2)
    else
        error('Type of model (variable modeltype) not recognized.')
    end

    for hh = 1:numel(C)

        hor = C{hh};

        % Write accuracy metrics (RMSE and FDA)
        Loop.(hor).results(n_iter_mod,1:5) = readmatrix(name_file, ...
                                                        'Sheet', ...
                                                        hor, ...
                                                        'Range', ...
                                                        'F124:F128'); % RMSE at all months
        Loop.(hor).results(n_iter_mod,6:10) = readmatrix(name_file, ...
                                                         'Sheet', ...
                                                         hor, ...
                                                         'Range', ...
                                                         'N124:N128'); % FDA at all months
        Loop.(hor).results(n_iter_mod,11:15) = readmatrix(name_file, ...
                                                          'Sheet', ...
                                                          hor, ...
                                                          'Range', ...
                                                          'F129:F133'); % RMSE at 1st month
        Loop.(hor).results(n_iter_mod,16:20) = readmatrix(name_file, ...
                                                          'Sheet', ...
                                                          hor, ...
                                                          'Range', ...
                                                          'N129:N133'); % FDA at 1st month
        Loop.(hor).results(n_iter_mod,21:25) = readmatrix(name_file, ...
                                                          'Sheet', ...
                                                          hor, ...
                                                          'Range', ...
                                                          'F134:F138'); % RMSE at 2nd month
        Loop.(hor).results(n_iter_mod,26:30) = readmatrix(name_file, ...
                                                          'Sheet', ...
                                                          hor, ...
                                                          'Range', ...
                                                          'N134:N138'); % FDA at 2nd month
        Loop.(hor).results(n_iter_mod,31:35) = readmatrix(name_file, ...
                                                          'Sheet', ...
                                                          hor, ...
                                                          'Range', ...
                                                          'F139:F143'); % RMSE at 3rd month
        Loop.(hor).results(n_iter_mod,36:40) = readmatrix(name_file, ...
                                                          'Sheet', ...
                                                          hor, ...
                                                          'Range', ...
                                                          'N139:N143'); % FDA at 3rd month
        
    end % end of loop on horizons

end % end of loop on iterations


% -------------------------------------------------------------------------
%% 2. WRITE THE SUMMARY EXCEL FILE
% -------------------------------------------------------------------------

% Delete past Excel file
delete(Loop.excel_loopfile);

for hh = 1:numel(C)

    hor = C{hh};

    % Write results of the loop
    writecell(Loop.results_names, ...
              Loop.excel_loopfile, ...                  
              'Sheet', ...
              hor, ...
              'Range', ...
              'A1') % names of the columns
    writecell(Loop.batch_id, ...
              Loop.excel_loopfile, ...
              'Sheet', ...
              hor, ...
              'Range', ...
              'A2') % batch name
    writematrix(Loop.parameters, ...
                Loop.excel_loopfile, ...
                'Sheet', ...
                hor, ...
                'Range', ...
                'B2') % parameters
    
    if strcmp(modeltype,'DFM') || strcmp(modeltype,'BEQ')

        writematrix(Loop.(hor).results, ...
                    Loop.excel_loopfile, ...
                    'Sheet', ...
                    hor, ...
                    'Range', ...
                    'I2') % accuracy metrics
        writecell(Loop.var_sel, ...
                  Loop.excel_loopfile, ...                  
                  'Sheet', ...
                  hor, ...
                  'Range', ...
                  'AW2') % variables and groups selected

    elseif strcmp(modeltype,'BVAR')

        writematrix(Loop.(hor).results, ...
                    Loop.excel_loopfile, ...
                    'Sheet', ...
                    hor, ...
                    'Range', ...
                    'G2') % accuracy metrics
        writecell(Loop.var_sel, ...
                  Loop.excel_loopfile, ...                  
                  'Sheet', ...
                  hor, ...
                  'Range', ...
                  'AU2') % variables and groups selected

    else
        error('Type of model (variable modeltype) not recognized.')
    end

end % end of loop on horizons